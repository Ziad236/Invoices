family_dictionary={
    "Food/Beverage": {
        "Fruits/Vegetables/Nuts/Seeds Prepared/Processed": {
            "code": "50100000",
            "description": "Arabic: لولو تمر مبروم المدينة 1 كجم | English: Turkish Dried Fig 500 g"
        },
        "Fish and Seafood": {
            "code": "50120000",
            "description": "Arabic: تريفا لحم تونا خفيف بالزيت النباتي 170 جرام | English: Young's 10 Fish Fingers 250 g"
        },
        "Milk/Butter/Cream/Yogurts/Cheese/Eggs/Substitutes": {
            "code": "50130000",
            "description": "Arabic: زبادي الصافي دانون كامل الدسم - 180 جرام | English: Earth's Finest Organic Coconut Cream 400 ml"
        },
        "Oils/Fats Edible": {
            "code": "50150000",
            "description": "Arabic: زيت الزيتون البكر الممتاز العضوي من شركة نادك 1 لتر | English: Cocos Organic Virgin Coconut Oil 1L"
        },
        "Confectionery/Sugar Sweetening Products": {
            "code": "50160000",
            "description": "Arabic: هيرشي كيسز المجموعة الكلاسيكية 4 نكهات 100 جم | English: Kinder Bueno Mini Chocolate with Milk & Hazelnut 108 g"
        },
        "Seasonings/Preservatives/Extracts": {
            "code": "50170000",
            "description": "Arabic: لولو ملح الهيمالايا الوردي 1.25 كجم | English: Tate & Lyle Dark Soft Brown Sugar 1kg"
        },
        "Bread/Bakery Products": {
            "code": "50180000",
            "description": "Arabic: خبز بر مصري-3 حبات | English: McVitie's Digestive Biscuits 250 g"
        },
        "Prepared/Preserved Foods": {
            "code": "50190000",
            "description": "Arabic: هاينز معجون طماطم 135 جم × 8 قطع | English: Luna Baked Beans In Tomato Sauce 380 g"
        },
        "Beverages": {
            "code": "50200000",
            "description": "Arabic: ماء جوز الهند العضوي من روبيكون 1 لتر | English: Natureland Organic Maple Syrup 250 ml"
        },
        "Cereal/Grain/Pulse Products": {
            "code": "50220000",
            "description": "Arabic: لولو أرز إيدلي 5 كجم | English: Orlanda Calrose Rice 5 kg"
        },
        "Meat/Poultry/Other Animals": {
            "code": "50240000",
            "description": "Arabic: ساديا فيليه صدور دجاج 750 جم | English: Sadia Chicken Breast Fillets 750g"
        },
        "Vegetables - Unprepared/Unprocessed (Frozen)": {
            "code": "50290000",
            "description": "Arabic: ساديا فاصوليا خضراء مقطعة مجمدة 450 غرام | English: Al Kabeer Frozen Mixed Vegetables 450g"
        },
        "Fruits - Unprepared/Unprocessed (Frozen)": {
            "code": "50270000",
            "description": "Arabic: السنبلة أناناس مجمد-400 غرام | English: Ocean Fruit Frozen Raspberries 350 g"
        },
        "Fruits - Unprepared/Unprocessed (Fresh)": {
            "code": "50250000",
            "description": "Arabic: رمان مصري (أنار) 1 كجم | English: Royal Gala Apples 1kg"
        },
        "Fruits/Vegetables Fresh Cut": {
            "code": "50380000",
            "description": "Arabic: أناناس مقشر 500 جرام | English: Fresh Pineapple Chunks 500g"
        },
        "Meat/Fish/Seafood Substitutes": {
            "code": "50390000",
            "description": "Arabic: بروتين نباتي مزخرف من انتونيز | English: Beyond Meat Plant-Based Burger 226g"
        },
        "Vegetables - Unprepared/Unprocessed (Shelf Stable)": {
            "code": "50320000",
            "description": "Arabic: سبانخ مستورد | English: Vacuum-Packed Baby Corn"
        },
        "Fruits - Unprepared/Unprocessed (Shelf Stable)": {
            "code": "50310000",
            "description": "Arabic: العطار تين مجفف 500 جرام | English: Sun-Maid California Raisins 500g"
        },
        "Nuts/Seeds - Unprepared/Unprocessed (Perishable)": {
            "code": "50330000",
            "description": "Arabic: جوز عين جمل من استرا، 400 جرام | English: Raw Cashew Nuts 500g"
        },
        "Nuts/Seeds - Unprepared/Unprocessed (In Shell)": {
            "code": "50340000",
            "description": "Arabic: نصف كيلو فستق حلبي نئ (غير محمص) | English: In-Shell Pistachios 1kg"
        },
        "Fruits/Vegetables Fresh & Fresh Cut": {
            "code": "50370000",
            "description": "Arabic: خيار طازج خالية من البكتيريا-عبوة عائلي | English: Pre-Cut Vegetable Platter"
        },
        "Vegetables (Non Leaf) - Unprepared/Unprocessed (Fresh)": {
            "code": "50260000",
            "description": "Arabic: قرنبيط شرائح - صحن 500 جرام | English: Fresh Bell Pepper Mix"
        },
        "Leaf Vegetables - Unprepared/Unprocessed (Fresh)": {
            "code": "50350000",
            "description": "Arabic: أوراق سبانخ صغيرة-حزمة | English: Fresh Romaine Lettuce"
        }
    },
    "Healthcare": {
        "Family Planning": {
            "code": "51110000",
            "description": "Arabic: ديوركس واقي ذكري للرجال مزلق | English: Durex Real Feel Condoms"
        },
        "Health Enhancement": {
            "code": "51120000",
            "description": "Arabic: لايف اكستنشين تركيبة الترا بروستاتا | English: Centrum Multivitamin Tablets"
        },
        "Medical Devices": {
            "code": "51150000",
            "description": "Arabic: جهاز تنفس صناعي الماني CARAT PRO | English: Omron M2 Basic Blood Pressure Monitor"
        },
        "Pharmaceutical Drugs": {
            "code": "51160000",
            "description": "Arabic: باراسيتامول 500 ملجم 24 قرص | English: Ibuprofen Tablets 200mg"
        },
        "Health Treatments/Aids": {
            "code": "51100000",
            "description": "Arabic: رقع لتخفيف الالم من 60 قطعة | English: Deep Heat Rub 100g"
        },
        "Home Diagnostics": {
            "code": "51130000",
            "description": "Arabic: جهاز قياس ضغط الدم الإلكتروني YKBP-9 | English: Beurer BM27 Blood Pressure Monitor"
        }
    },
    "Clothing": {
        "Clothing": {
            "code": "67010000",
            "description": "Arabic: جاكيت صيفي كاجوال سادة بغطاء للراس للنساء | English: Men's Classic Twill Relaxed Fit Cargo Trousers"
        },
        "Activewear": {
            "code": "67030000",
            "description": "Arabic: سروال رياضي بمقاس كبير ايكوسمارت للنساء | English: Nike Dri-FIT Running Shorts"
        },
        "Underwear": {
            "code": "67040000",
            "description": "Arabic: ملابس داخلية جي سترينغ للنساء من دريس سيسي | English: Calvin Klein Men's Trunk 3-Pack"
        },
        "Swimwear": {
            "code": "67060000",
            "description": "Arabic: ملابس سباحة للنساء المسلمات بمقاس كبير بوركيني | English: Speedo Women's One-Piece Swimsuit"
        },
        "Protective Wear": {
            "code": "67050000",
            "description": "Arabic: نظارات امان فوق النظارات من نالاكال | English: BMB Tools Safety Helmet"
        },
        "Sleepwear": {
            "code": "67020000",
            "description": "Arabic: بيجامة صوف شتوية للنساء من كوزيبوين | English: UGG Women's Duvall II Slippers"
        }
    },
    "Home Appliances": {
        "Major Domestic Appliances": {
            "code": "72010000",
            "description": "Arabic: غسالة قابلة للطي من موجوكو | English: Bosch Washing Machine 7kg"
        },
        "Small Domestic Appliances": {
            "code": "72020000",
            "description": "Arabic: مفرمة زجاجية متعددة الوظائف من بلاك آند ديكر | English: Braun Multiquick 7 Hand Blender"
        }
    },
    "Electrical Supplies": {
        "Electrical Connection/Distribution": {
            "code": "78020000",
            "description": "Arabic: صندوق توزيع مدمج بـ36 منفذ | English: GEVEELIFE Waterproof Junction Box"
        },
        "Electrical Lighting": {
            "code": "78030000",
            "description": "Arabic: مصباح سقف معدني عتيق صناعي | English: TERRIFI Dimmable LED Moon Wall Lamp"
        },
        "Electrical Cabling/Wiring": {
            "code": "78040000",
            "description": "Arabic: شريط كهربائي مقاوم للإشتعال أسود | English: KabelDirekt Cat 6 Ethernet Cable"
        },
        "General Electrical Hardware": {
            "code": "78060000",
            "description": "Arabic: قلم اختبار الجهد الكهربائي العملي | English: AstroAI Digital Multimeter"
        },
        "Electronic Communication Components": {
            "code": "78050000",
            "description": "Arabic: لوحة توصيل لوحة الكترونية مطبوعة | English: ELEGOO UNO R3 Starter Kit"
        }
    },
    "Computing": {
        "Computers/Video Games": {
            "code": "65010000",
            "description": "Arabic: كاسيو ساعة يد بعقارب وسوار من الستانلس ستيل | English: ASUS TUF Gaming B760M-PLUS Motherboard"
        }
    },
    "Tools/Equipment": {
        "Tools/Equipment": {
            "code": "74010000",
            "description": "Arabic: مجموعة ادوات صيانة السيارة | English: BLACK+DECKER 126-Piece Tool Set"
        }
    },
    "Camping": {
        "Camping": {
            "code": "75010000",
            "description": "Arabic: كرسي تخييم قابل للطي مع حقيبة حمل | English: Eacam Camping Sleeping Pad"
        }
    },
    "Arts/Crafts/Needlework": {
        "Arts/Crafts/Needlework Supplies": {
            "code": "70010000",
            "description": "Arabic: مجموعة ادوات نحت احترافية مع 20 قطعة | English: UCHIDA Corru-Gator Paper Crimper"
        }
    },
    "Music": {
        "Musical Instruments/Accessories": {
            "code": "61010000",
            "description": "Arabic: غيتار كلاسيكي بالحجم الكامل C40 II من ياماها | English: Yamaha C40 Full-Size Classical Guitar"
        }
    }
}

import os
import json
import time
import pandas as pd
import numpy as np
from sklearn.metrics import accuracy_score, f1_score
from groq import Groq
from tqdm import tqdm

class InferencePipeline:
    def __init__(self, dataset_path, groq_api_key):
        self.batch_size = 5
        self.dataset = self.load_dataset(dataset_path)
        self.groq_client = Groq(api_key=groq_api_key)
        self.few_shot_examples = family_dictionary

        self.segment_mapping = {
            'Food/Beverage': '50000000',
            'Healthcare': '51000000',
            'Home Appliances': '72000000',
            'Electrical Supplies': '78000000',
            'Clothing': '67000000',
            "Computing":"65000000",
            "Tools/Equipment":"80000000",
            "Camping":"74000000",
            "Arts/Crafts/Needlework":"70000000",
            "Music":"61000000",
        }

        self.family_mapping = {
    'Bread/Bakery Products': '50180000',
    'Beverages': '50200000',
    'Vegetables - Unprepared/Unprocessed (Frozen)': '50290000',
    'Fruits/Vegetables/Nuts/Seeds Prepared/Processed': '50100000',
    'Fruits - Unprepared/Unprocessed (Fresh)':'50250000',
    'Fruits/Vegetables Fresh Cut': '50380000',
    'Fruits/Vegetables Fresh & Fresh Cut' :'50370000',
    'Fruits - Unprepared/Unprocessed (Frozen)' :'50270000',
    'Fruits - Unprepared/Unprocessed (Shelf Stable)': '50310000',
    'Cereal/Grain/Pulse Products': '50220000',
    'Prepared/Preserved Foods': '50190000',
    'Meat/Poultry/Other Animals': '50240000',
    'Nuts/Seeds - Unprepared/Unprocessed (Perishable)': '50330000',
    'Nuts/Seeds - Unprepared/Unprocessed (In Shell)': '50340000',
    'Vegetables (Non Leaf) - Unprepared/Unprocessed (Fresh)': '50260000',
    'Vegetables - Unprepared/Unprocessed (Shelf Stable)' :'50320000',
    'Leaf Vegetables - Unprepared/Unprocessed (Fresh)' :'50350000',
    'Fish and Seafood': '50120000',
    'Food/Beverage Variety Packs': '50230000',
    'Meat/Fish/Seafood Substitutes': '50390000',
    'Milk/Butter/Cream/Yogurts/Cheese/Eggs/Substitutes': '50130000',
    'Seasonings/Preservatives/Extracts': '50170000',
    'Oils/Fats Edible': '50150000',
    'Confectionery/Sugar Sweetening Products': '50160000',
    'Health Treatments/Aids': '51100000',
    'Pharmaceutical Drugs': '51160000',
    'Health Enhancement': '51120000',
    'Healthcare Variety Packs': '51140000',
    'Medical Devices': '51150000',
    'Home Diagnostics': '51130000',
    'Veterinary Healthcare': '51170000',
    'Family Planning': '51110000',
    'Small Domestic Appliances': '72020000',
    'Major Domestic Appliances': '72010000',
    'Activewear': '67030000',
    'Clothing': '67010000',
    'Protective Wear': '67050000',
    'Swimwear': '67060000',
    'Sleepwear': '67020000',
    'Underwear': '67040000',
    'General Electrical Hardware': '78060000',
    'Electronic Communication Components': '78050000',
    'Electrical Lighting': '78030000',
    'Electrical Cabling/Wiring': '78040000',
    'Electrical Connection/Distribution': '78020000',
    'Computers/Video Games': '65010000',
    'Tools/Equipment': '74010000',
    'Camping': '75010000',
    'Arts/Crafts/Needlework Supplies': '70010000',
    'Musical Instruments/Accessories': '61010000'
}

        self.candidate_labels = {
            'segments': list(self.segment_mapping.keys()),
            'families': list(self.family_mapping.keys()),
        }

        self.segment_to_families = {
    "Food/Beverage": [
        'Fruits/Vegetables/Nuts/Seeds Prepared/Processed',
        'Fish and Seafood',
        'Milk/Butter/Cream/Yogurts/Cheese/Eggs/Substitutes',
        'Oils/Fats Edible',
        'Confectionery/Sugar Sweetening Products',
        'Seasonings/Preservatives/Extracts',
        'Bread/Bakery Products',
        'Prepared/Preserved Foods',
        'Beverages',
        'Cereal/Grain/Pulse Products',
        'Meat/Poultry/Other Animals',
        'Vegetables - Unprepared/Unprocessed (Frozen)',
        'Fruits - Unprepared/Unprocessed (Frozen)',
        'Fruits - Unprepared/Unprocessed (Fresh)',
        'Fruits/Vegetables Fresh Cut',
        'Food/Beverage Variety Packs',
        'Meat/Fish/Seafood Substitutes',
        'Vegetables - Unprepared/Unprocessed (Shelf Stable)',
        'Fruits - Unprepared/Unprocessed (Shelf Stable)',
        'Nuts/Seeds - Unprepared/Unprocessed (Perishable)',
        'Nuts/Seeds - Unprepared/Unprocessed (In Shell)',
        'Fruits/Vegetables Fresh & Fresh Cut',
        'Vegetables (Non Leaf) - Unprepared/Unprocessed (Fresh)',
        'Leaf Vegetables - Unprepared/Unprocessed (Fresh)'
    ],
    "Healthcare": [
        'Family Planning',
        'Health Enhancement',
        'Healthcare Variety Packs',
        'Medical Devices',
        'Pharmaceutical Drugs',
        'Health Treatments/Aids',
        'Veterinary Healthcare',
        'Home Diagnostics'
    ],
    "Clothing": [
        'Clothing',
        'Activewear',
        'Underwear',
        'Swimwear',
        'Protective Wear',
        'Sleepwear'
    ],
    "Home Appliances": [
        'Major Domestic Appliances',
        'Small Domestic Appliances'
    ],
    "Electrical Supplies": [
        'Electrical Connection/Distribution',
        'Electrical Lighting',
        'Electrical Cabling/Wiring',
        'General Electrical Hardware',
        'Electronic Communication Components'
    ],
    "Computing": [
        'Computers/Video Games'
    ],
    "Tools/Equipment": [
        'Tools/Equipment'
    ],
    "Camping": [
        'Camping'
    ],
    "Arts/Crafts/Needlework": [
        'Arts/Crafts/Needlework Supplies'
    ],
    "Music": [
        'Musical Instruments/Accessories'
    ]
}

        self.example_cache = {
            'segments': self._prepare_segment_examples(),
            'families': self._prepare_family_examples()
        }

    def _prepare_segment_examples(self):
        """Create few-shot examples for segment classification"""
        examples = []
        for segment, families in self.few_shot_examples.items():
            for family_name, family_data in families.items():
                examples.append(
                    f"Product: {family_data['description']}\n"
                    f"Segment: {segment}"
                )
        return examples

    def _prepare_family_examples(self):
        """Create few-shot examples for family classification"""
        examples = {}
        for segment, families in self.few_shot_examples.items():
            segment_examples = []
            for family_name, family_data in families.items():
                segment_examples.append(
                    f"Product: {family_data['description']}\n"
                    f"Family: {family_name}"
                )
            examples[segment] = segment_examples
        return examples

    def load_dataset(self, path):
        """Load dataset and validate required columns."""
        required_columns = ['item_name', 'item_segment', 'item_family']
        df = pd.read_csv(path,encoding='utf-8 sig')

        missing = [col for col in required_columns if col not in df.columns]
        if missing:
            raise ValueError(f"Missing columns: {missing}")

        df['item_segment'] = df['item_segment'].fillna('Unknown').astype('category')
        df['item_family'] = df['item_family'].fillna('Unknown').astype('category')

        return df

    def process_batch(self, batch, model_name):
        """Process a batch of items with few-shot learning"""
        responses = []
        start_time = time.time()

        for item in batch:
            try:

                seg_examples = "\n\n".join(self.example_cache['segments'][:3])
                prompt_seg = (
                    f"Classify the product segment using these examples:\n{seg_examples}\n\n"
                    f"New product: {item['item_name']}\n"
                    f"Options: {self.candidate_labels['segments']}\n"
                    "Respond with JSON containing:\n"
                    "- segment_name (string)"
                )
                
                seg_response = self.groq_client.chat.completions.create(
                    messages=[{"role": "user", "content": prompt_seg}],
                    model=model_name,
                    response_format={"type": "json_object"},
                    temperature=0.1
                )
                seg_data = json.loads(seg_response.choices[0].message.content)
                predicted_segment = seg_data.get('segment_name', '').strip()

                families_for_segment = self.segment_to_families.get(predicted_segment, [])
                fam_examples = "\n\n".join(
                    self.example_cache['families'].get(predicted_segment, [])[:2]
                )
                prompt_family = (
                    f"Classify the product family using these examples:\n{fam_examples}\n\n"
                    f"New product: {item['item_name']}\n"
                    f"Options under {predicted_segment}: {families_for_segment}\n"
                    "Respond with JSON containing:\n"
                    "- family_name (string)"
                )

                fam_response = self.groq_client.chat.completions.create(
                    messages=[{"role": "user", "content": prompt_family}],
                    model=model_name,
                    response_format={"type": "json_object"},
                    temperature=0.1
                )
                fam_data = json.loads(fam_response.choices[0].message.content)
                predicted_family = fam_data.get('family_name', '').strip()

                responses.append({
                    "item_name": item['item_name'],
                    "segment_code": self.segment_mapping.get(predicted_segment, ''),
                    "segment_name": predicted_segment,
                    "family_code": self.family_mapping.get(predicted_family, ''),
                    "family_name": predicted_family
                })
            except Exception as e:
                print(f"Error processing {item['item_name']}: {str(e)}")
                responses.append({
                    "item_name": item['item_name'],
                    "segment_code": '',
                    "segment_name": '',
                    "family_code": '',
                    "family_name": ''
                })

        inference_time = time.time() - start_time
        return responses, inference_time / len(batch)


    def evaluate_model(self, model_name, sample):
        """Evaluate the model using micro F1-score, accuracy, and average inference time."""
        true_segments = sample['item_segment'].cat.codes.tolist()
        true_families = sample['item_family'].cat.codes.tolist()

        preds_segment = []
        preds_family = []
        inference_times = []

        for i in range(0, len(sample), self.batch_size):
            batch = sample.iloc[i:i + self.batch_size].to_dict('records')
            batch_preds, batch_time = self.process_batch(batch, model_name)

            preds_segment.extend([
                sample['item_segment'].cat.categories.get_loc(p['segment_name'])
                if p['segment_name'] in sample['item_segment'].cat.categories else -1
                for p in batch_preds
            ])

            preds_family.extend([
                sample['item_family'].cat.categories.get_loc(p['family_name'])
                if p['family_name'] in sample['item_family'].cat.categories else -1
                for p in batch_preds
            ])

            inference_times.append(batch_time)

        return {
            'accuracy_segment': accuracy_score(true_segments, preds_segment),
            'f1_segment': f1_score(true_segments, preds_segment, average='micro'),
            'accuracy_family': accuracy_score(true_families, preds_family),
            'f1_family': f1_score(true_families, preds_family, average='micro'),
            'avg_inference_time': np.mean(inference_times)
        }

    def run_pipeline(self, models, output_dir):
        """Run the pipeline with progress tracking"""
        os.makedirs(output_dir, exist_ok=True)
        eval_sample = self.dataset.sample(frac=0.2, random_state=42)
        results = {}

        for model in models:
            all_predictions = []
            total_batches = (len(self.dataset) + self.batch_size - 1) // self.batch_size

            with tqdm(total=total_batches, desc=f"Processing {model}") as progress_bar:
                for i in range(0, len(self.dataset), self.batch_size):
                    batch = self.dataset.iloc[i:i + self.batch_size].to_dict('records')
                    batch_preds, batch_time = self.process_batch(batch, model)
                    
                    all_predictions.extend([{
                        'Item_name': item['item_name'],
                        'true_label': f"{item['item_segment']}|{item['item_family']}",
                        'prediction': f"{pred['segment_name']}|{pred['family_name']}",
                        'inference_time': batch_time
                    } for item, pred in zip(batch, batch_preds)])
                    
                    progress_bar.update(1)
                    progress_bar.set_postfix({
                        'completed': f"{min(i+self.batch_size, len(self.dataset))}/{len(self.dataset)}",
                        'batch_time': f"{batch_time:.2f}s"
                    })

            gpu_type = 'GROQ-LPU'
            filename = f"{output_dir}/{model.replace('/', '-')}_{gpu_type}.csv"
            pd.DataFrame(all_predictions).to_csv(filename, index=False)
            results[model] = self.evaluate_model(model, eval_sample)
            
        with open(f"{output_dir}/performance.json", 'w') as f:
            json.dump(results, f, indent=2)

        return results

if __name__ == '__main__':
    config = {
        'dataset_path': '/kaggle/input/few-shot-data/arabic_test_data.csv',
        'groq_api_key': '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',
        'models_to_test': ['gemma2-9b-it'],
        'output_dir': '/kaggle/working/results'
    }

    pipeline = InferencePipeline(config['dataset_path'], config['groq_api_key'])
    performance = pipeline.run_pipeline(config['models_to_test'], config['output_dir'])
    print("\nPerformance Results:", json.dumps(performance, indent=2))